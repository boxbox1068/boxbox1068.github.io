<!DOCTYPE html>
<meta charset="utf-8">
<title>鼠算式フレーズ練習帳</title>
<meta name="author" content="@shikaku1068">
<meta name="description" content="">
<link rel="icon" type="image/png" href="">
<link rel="canonical" href="https://shikaku1068.github.io/rampf/">
<meta name="viewport" content="width=device-width">
<meta name="format-detection" content="telephone=no,address=no,email=no">
<script type="module">
  import {QueryParser} from './js/query-parser.js';
  import {RabbitPhrase} from './js/rabbit-phrase.js';
  const dataset = {};
  const elements = {};
  const main = () => {
    for (const element of document.querySelectorAll('[id]')) {
      if (element.id) {
        const key = element.id.replace(/-(.)/g, (match, p1, offset, string) => {
          return p1.toUpperCase();
        });
        elements[key] = element;
      }
    }
    const queryParser = new QueryParser();
    dataset.leadText = queryParser.getValue('lead', 'string', '');
    dataset.questionTemplate = queryParser.getValue('question', 'string', '');
    dataset.answerTemplate = queryParser.getValue('answer', 'string', '');
    dataset.answerLang = queryParser.getValue('lang', 'string', '');
    dataset.animation = queryParser.getValue('animation', 'string', '').trim().toLowerCase();
    dataset.isAnswerShown = true;
    dataset.trainingCount = 0;

    // dummy
    {
      dataset.leadText = '';

      dataset.questionTemplate = 'もし私が^[鳥|魚|犬|猫|馬]だったら^[空を自由に飛べる|海深くまで泳げる|君の匂いを嗅ぎ分けられる|一日中寝ていられる|風より速く走れる]んだけど。';
      dataset.answerTemplate = 'If I were ^[a bird|a fish|a dog|a cat|a horse], I could ^[fly freely in the sky|swim deep in the ocean|pick up your scent|sleep all day long|run faster than wind].';

      dataset.questionTemplate = '^[私|君|彼|彼女|私たちの|君たち|彼ら|彼女ら]の^^[誕生日|結婚記念日|命日]は^^^[1|2|3|4|5|6|7|8|9|10|11|12]月^^^^[1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|^^^[30||30|30|30|30|30|30|30|30|30|30]|^^^[31||31||31||31|31||31||31]]日^^^^^[です|だった|になるだろう]。';
      dataset.answerTemplate = '^[My|Your|His|Her|Our|Your|Their|Their] ^^[birthday|wedding anniversary|death anniversary] ^^^^^[is|was|will be] ^^^[January|February|March|April|May|June|July|August|September|October|November|December] ^^^^[1st|2nd|3rd|4th|5th|6th|7th|8th|9th|10th|11th|12th|13th|14th|15th|16th|17th|18th|19th|20th|21st|22nd|23rd|24th|25th|26th|27th|28th|29th|^[30th||30th|30th|30th|30th|30th|30th|30th|30th|30th|30th]|^[31st||31st||31st||31st|31st||31st||31st]].';

      dataset.questionTemplate = '^[彼ら|彼女ら]は親切^^[だ|だった]。';
      dataset.answerTemplate = '^[They|-] ^^[are|were] kind.';

      dataset.questionTemplate = '^[1|2|3|4|5|6|7|8|9|10|11|12]月^^[1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|^[|!||||||||||]30|^[|!||!||!|||!||!|]31]日';
      dataset.answerTemplate = '^[1|2|3|4|5|6|7|8|9|10|11|12]月^^[1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|^[|!||||||||||]30|^[|!||!||!|||!||!|]31]日';
/*
^[1|2|3|4|5|6|7|8|9|10|11|12]月^[1+2+3+4+5+6+7+8+9+10+11+12+13+14+15+16+17+18+19+20+21+22+23+24+25+26+27+28+29+30+31|||||||||||]日

^[1|2|3|4|5|6|7|8|9|10|11|12]月^^[1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|^[|!||||||||||]30|^[|!||!||!|||!||!|]31]
*/

      dataset.animation = 'slide';
    }

    if (dataset.leadText) {
      elements.leadContent.append(dataset.leadText);
    }
    elements.playAudioButton.addEventListener('click', playAudio);
    elements.autoPlayAudioCheckbox.addEventListener('change', event => {
      dataset.isAutoPlayAudioEnabled = event.target.checked;
    });
    elements.continueButton.addEventListener('click', event => {
      if (dataset.isAnswerShown) {
        resetCard();
      } else {
        showAnswer();
      }
    });
    elements.skipButton.addEventListener('click', resetCard);
    resetCard();
  };
  const resetCard = () => {
    const pathIdSeed = Math.random();
    dataset.questionPhrase = new RabbitPhrase(dataset.questionTemplate, pathIdSeed);
    dataset.answerPhrase = new RabbitPhrase(dataset.answerTemplate, pathIdSeed);
    elements.patternCount.innerHTML = dataset.questionPhrase.possiblePathCount;
    elements.patternId.innerHTML = dataset.questionPhrase.pathId;
    elements.trainingCount.innerHTML = dataset.trainingCount++;
    showQuestion();
  };
  const showQuestion = () => {
    disableButtons();
    if (dataset.animation == 'flip') {
      addAnimation(elements.questionWrapper, 'flipA 250ms', target => {
        resetQuestion();
        elements.questionCover.style.visibility = 'hidden';
        addAnimation(elements.questionWrapper, 'flipB 250ms', target => {
          enableButtons();
        });
      });
      if (dataset.isAnswerShown) {
        addAnimation(elements.answerWrapper, 'flipA 250ms', target => {
          resetAnswer();
          elements.answerCover.style.visibility = 'visible';
          addAnimation(elements.answerWrapper, 'flipB 250ms', null);
        });
      } else {
        resetAnswer();
      }
    } else if (dataset.animation == 'slide') {
      addAnimation(
        elements.questionCover,
        elements.questionCover.style.visibility == 'hidden' ? 'slideInFromLeft 500ms' : 'dummySlide 0',
        target => {
          resetQuestion();
          addAnimation(elements.questionCover, 'slideOutToRight 500ms', target => {
            elements.questionCover.style.visibility = 'hidden';
            enableButtons();
          });
        }
      );
      addAnimation(
        elements.answerCover,
        elements.answerCover.style.visibility == 'hidden' ? 'slideInFromLeft 500ms' : 'dummySlide 0',
        target => {
          resetAnswer();
          elements.answerCover.style.visibility = 'visible';
        }
      );
    } else {
      resetQuestion();
      elements.questionCover.style.visibility = 'hidden';
      resetAnswer();
      elements.answerCover.style.visibility = 'visible';
      enableButtons();
    }
    dataset.isAnswerShown = false;
  };
  const resetQuestion = () => {
    elements.questionWrapper.scrollTop = 0;
    elements.questionContent.innerHTML = dataset.questionPhrase.html;
    addHintBalloons(elements.questionContent, dataset.answerPhrase.chosenBranchTexts);
  };
  const resetAnswer = () => {
    elements.answerWrapper.scrollTop = 0;
    elements.answerContent.innerHTML = dataset.answerPhrase.html;
    addHintBalloons(elements.answerContent, dataset.questionPhrase.chosenBranchTexts);
  }
  const addHintBalloons = (targetContent, hintTextList) => {
    const branchElements = targetContent.querySelectorAll('.branch');
    for (const branchElement of branchElements) {
      const branchNumber = Number(branchElement.dataset.branchNumber);
      const hintBalloonContentElement = document.createElement('span');
      hintBalloonContentElement.className = 'hint-balloon-content';
      hintBalloonContentElement.innerText = hintTextList[branchNumber];
      const hintBalloonWrapperElement = document.createElement('span');
      hintBalloonWrapperElement.className = 'hint-balloon-wrapper';
      hintBalloonWrapperElement.append(hintBalloonContentElement);
      branchElement.append(hintBalloonWrapperElement);
      const hintBalloonRight = branchElement.getClientRects()[0].left + hintBalloonWrapperElement.offsetWidth;
      const hintBalloonContentMarginLeft = Math.min(0, document.body.offsetWidth - hintBalloonRight);
      hintBalloonContentElement.style.marginLeft = `${hintBalloonContentMarginLeft}px`;
      branchElement.addEventListener('mouseenter', event => {
        const branchElement = event.target;
        const hintBalloonWrapperElement = branchElement.querySelector('.hint-balloon-wrapper');
        const branchRect = branchElement.getClientRects()[0];
        hintBalloonWrapperElement.style.top = `${branchRect.top}px`;
        hintBalloonWrapperElement.style.left = `${branchRect.left}px`;
        hintBalloonWrapperElement.style.animation = 'fadeIn 500ms';
      });
      branchElement.addEventListener('mouseleave', event => {
        const branchElement = event.target;
        const hintBalloonWrapperElement = branchElement.querySelector('.hint-balloon-wrapper');
        hintBalloonWrapperElement.style.animation = 'fadeOut 500ms';
      });
    }
  }
  const showAnswer = () => {
    disableButtons();
    if (dataset.animation == 'flip') {
      addAnimation(elements.answerWrapper, 'flipA 250ms', target => {
        elements.answerCover.style.visibility = 'hidden';
        addAnimation(elements.answerWrapper, 'flipB 250ms', target => {
          enableButtons();
          if (dataset.isAutoPlayAudioEnabled) playAudio();
        });
      });
    } else if (dataset.animation == 'slide') {
      addAnimation(elements.answerCover, 'slideOutToRight 500ms', target => {
        elements.answerCover.style.visibility = 'hidden';
        enableButtons();
        if (dataset.isAutoPlayAudioEnabled) playAudio();
      });
    } else {
      elements.answerCover.style.visibility = 'hidden';
      enableButtons();
      if (dataset.isAutoPlayAudioEnabled) playAudio();
    }
    dataset.isAnswerShown = true;
  };
  const addAnimation = (target, animation, callback) => {
    const eventHandler = event => {
      target.removeEventListener('animationend', eventHandler);
      target.style.animation = '';
      callback && callback(target);
    }
    target.addEventListener('animationend', eventHandler);
    target.style.animation = animation;
  };
  const playAudio = () => {
  	const uttearnce = new SpeechSynthesisUtterance();
   	uttearnce.text = dataset.answerPhrase.text;
   	uttearnce.volume = 1;
   	uttearnce.rate = 1;
   	uttearnce.pitch = 1;
   	uttearnce.lang = 'en-US';
   	window.speechSynthesis.speak(uttearnce);
  };
  const disableButtons = () => {
    elements.playAudioButton.disabled = true;
    elements.continueButton.disabled = true;
    elements.skipButton.disabled = true;
  };
  const enableButtons = () => {
    elements.playAudioButton.disabled = false;
    elements.continueButton.disabled = false;
    elements.skipButton.disabled = false;
  };
  window.addEventListener('DOMContentLoaded', main);
</script>
<style>
  :root {
    --background-color: #ccc;
    --panel-color: #fff;
    font-size: 4vmin;
    font-family: sans-serif;
  }
  * {
    box-sizing: border-box;
    overflow: hidden;
    animation-fill-mode: forwards;
  }
  body {
    display: grid;
    grid-template:
      "lead lead" min-content
      "question answer" 1fr
      "controller controller" min-content
      "statistic copyright" min-content
      / 50% 50%;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    margin: 0;
    overflow: hidden;
    background-color: var(--background-color);
  }
  @media screen and (orientation: portrait) {
    body {
      grid-template:
        "lead" min-content
        "question" 1fr
        "answer" 1fr
        "controller" min-content
        "statistic" min-content
        "copyright" min-content
        / 100%;
    }
  }
  #lead-wrapper {
    grid-area: lead;
    min-height: 2rem;
    max-height: 15vh;
    padding: .5rem 1rem;
    overflow-y: auto;
  }
  #lead-content {
    font-size: 1.25rem;
    overflow-wrap: break-word;
    line-height: 1.5em;
  }
  #question-wrapper {
    grid-area: question;
    margin: .5rem .5rem .5rem 0;
  }
  #answer-wrapper {
    grid-area: answer;
    margin: .5rem 0 .5rem .5rem;
  }
  #question-wrapper,
  #answer-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    padding: .5rem 1rem;
    overflow-y: auto;
    background-color: var(--panel-color);
  }
  #question-background,
  #answer-background,
  #question-cover,
  #answer-cover {
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    font-weight: bold;
    font-size: 10rem;
  }
  #question-background:before,
  #question-cover:before {
    content: "Q";
  }
  #answer-background:before,
  #answer-cover:before {
    content: "A";
  }
  #question-background,
  #answer-background {
    background-color: white;
    color: lightgray;
  }
  #question-cover,
  #answer-cover {
    visibility: hidden;
    background-color: purple;
    color: black;
  }
  #question-content,
  #answer-content {
    position: relative;
    margin: auto;
    font-size: 1.5rem;
    overflow-wrap: break-word;
    line-height: 1.5em;
  }
  #controller-wrapper {
    grid-area: controller;
    padding: .5rem 1rem;
    text-align: right;
  }
  #play-audio-button {
    width: 3rem;
    height: 3rem;
    font-size: 1.5rem;
  }
  #auto-play-audio-checkbox {
    display: none;
  }
  #auto-play-audio-checkbox + label {
    --border-width: 2px;
    --toggle-height: 2rem;
    overflow: hidden;
    box-sizing: border-box;
    display: inline-block;
    position: relative;
    width: 1.5rem;
    height: 3rem;
    border: var(--border-width) solid gray;
    background: gray;
    vertical-align: bottom;
  }
  #auto-play-audio-checkbox + label::before {
    box-sizing: border-box;
    display: block;
    position: absolute;
    top: calc(var(--border-width) * -1);
    left: 0;
    width: 100%;
    height: 0;
    border-width: 0 0 var(--border-width) 0;
    border-style: solid;
    border-color: gray;
    background-color: lightgray;
    animation-fill-mode: forwards;
    content: "";
  }
  #auto-play-audio-checkbox + label::after {
    box-sizing: border-box;
    overflow: hidden;
    display: block;
    position: absolute;
    bottom: calc(var(--border-width) * -1);
    left: 0;
    width: 100%;
    height: var(--toggle-height);
    border-width: var(--border-width) 0 0 0;
    border-style: solid;
    border-color: gray;
    background-color: lime;
    content: "";
  }
  #auto-play-audio-checkbox:not(:checked) + label::before {
    animation: hoge 500ms;
    animation-fill-mode: forwards;
  }
  #auto-play-audio-checkbox:not(:checked) + label::after {
    animation: hogehoge 500ms;
    animation-fill-mode: forwards;
  }
  #auto-play-audio-checkbox:checked + label::before {
    animation: hogehoge 500ms;
    animation-fill-mode: forwards;
  }
  #auto-play-audio-checkbox:checked + label::after {
    animation: hoge 500ms;
    animation-fill-mode: forwards;
  }
  @keyframes hoge {
    0% {
      height: 0;
    }
    100% {
      height: var(--toggle-height);
    }
  }
  @keyframes hogehoge {
    0% {
      height: var(--toggle-height);
    }
    100% {
      height: 0;
    }
  }
  


  #continue-button {
    width: 6rem;
    height: 3rem;
    font-size: 1.5rem;
  }
  #skip-button {
    width: 3rem;
    height: 3rem;
    font-size: 1.5rem;
  }
  #statistic-wrapper {
    grid-area: statistic;
    padding: .5rem 1rem;
    font-size: .75rem;
  }
  #copyright-wrapper {
    grid-area: copyright;
    padding: .5rem 1rem;
    font-size: .75rem;
    text-align: right;
  }
  .branch {
    font-weight: bold;
  }
  .branch[data-branch-number="1"],
  .branch[data-branch-number="6"] {
    background-color: #F82F6666;
  }
  .branch[data-branch-number="2"],
  .branch[data-branch-number="7"] {
    background-color: #008ECF66;
  }
  .branch[data-branch-number="3"],
  .branch[data-branch-number="8"] {
    background-color: #70BE4766;
  }
  .branch[data-branch-number="4"],
  .branch[data-branch-number="9"] {
    background-color: #F55A2166;
  }
  .branch[data-branch-number="5"],
  .branch[data-branch-number="0"] {
    background-color: #F0EA3066;
  }
  .hint-balloon-wrapper {
    --hint-balloon-font-size: 1em;
    --hint-balloon-height: calc(var(--hint-balloon-font-size) * 1.6);
    --hint-balloon-background-color: #fff;
    --hint-balloon-border-color: #999;
    --hint-balloon-border-width: .2rem;
    display: block;
    visibility: hidden;
    position: fixed;
    z-index: 1000;
    height: var(--hint-balloon-height);
    margin-top: calc(var(--hint-balloon-height) * -1 - var(--hint-balloon-border-width));
    overflow: visible;
    font-weight: bold;
    font-size: var(--hint-balloon-font-size);
  }
  .hint-balloon-wrapper:before {
    display: block;
    position: absolute;
    top: 100%;
    left: calc(var(--hint-balloon-border-width) * 2);
    border: calc(var(--hint-balloon-border-width) * 2) solid transparent;
    border-top: calc(var(--hint-balloon-border-width) * 4) solid var(--hint-balloon-border-color);
    content: "";
  }
  .hint-balloon-wrapper::after {
    display: block;
    position: absolute;
    top: calc(100% - .2rem * 2);
    left: calc(var(--hint-balloon-border-width) * 2);
    border: calc(var(--hint-balloon-border-width) * 2) solid transparent;
    border-top: calc(var(--hint-balloon-border-width) * 4) solid var(--hint-balloon-background-color);
    content: "";
  }
  .hint-balloon-content {
    display: flex;
    align-items: center;
    height: 100%;
    padding: 0 calc(var(--hint-balloon-border-width) * 2);
    border: var(--hint-balloon-border-width) solid var(--hint-balloon-border-color);
    background-color: var(--hint-balloon-background-color);
    white-space: nowrap;
  }
  .branch:hover .hint-balloon-wrapper {
    visibility: visible;
  }
  @keyframes flipA {
    0% {
      transform: rotateX(0);
    }
    100% {
      transform: rotateX(90deg);
    }
  }
  @keyframes flipB {
    0% {
      transform: rotateX(-90deg);
    }
    100% {
      transform: rotateX(0);
    }
  }
  @keyframes slideInFromLeft {
    0% {
      visibility: visible;
      left: -100%;
    }
    100% {
      left: 0;
    }
  }
  @keyframes slideOutToLeft {
    0% {
      visibility: visible;
      left: 0;
    }
    100% {
      left: -100%;
    }
  }
  @keyframes slideInFromRight {
    0% {
      visibility: visible;
      left: 100%;
    }
    100% {
      left: 0;
    }
  }
  @keyframes slideOutToRight {
    0% {
      visibility: visible;
      left: 0;
    }
    100% {
      left: 100%;
    }
  }
  @keyframes dummySlide {
    0% {
    }
    100% {
    }
  }
  @keyframes fadeIn {
    0% {
      visibility: hidden;
      opacity: 0;
    }
    100% {
      visibility: visible;
      opacity: 1;
    }
  }
  @keyframes fadeOut {
    0% {
      visibility: visible;
      opacity: 1;
    }
    100% {
      visibility: hidden;
      opacity: 0;
    }
  }
</style>
<div id="lead-wrapper">
  <div id="lead-content"></div>
</div>
<div id="question-wrapper">
  <div id="question-background"></div>
  <div id="question-content"></div>
  <div id="question-cover"></div>
</div>
<div id="answer-wrapper">
  <div id="answer-background"></div>
  <div id="answer-content"></div>
  <div id="answer-cover"></div>
</div>
<div id="controller-wrapper">
  <div id="controller-content">
    <button id="play-audio-button">&#x1f4ac;</button>
    <input type="checkbox" id="auto-play-audio-checkbox">
    <label for="auto-play-audio-checkbox"></label>
    <button id="continue-button">&#x25b6;</button>
    <button id="skip-button">&#x23ed;</button>
  </div>
</div>
<div id="statistic-wrapper">
  <div id="statistic-content">
    <span>（総パターン数：<span id="pattern-count"></span>，パターンID：<span id="pattern-id"></span>，練習回数：<span id="training-count"></span>）</span>
  </div>
</div>
<div id="copyright-wrapper">
  <div id="copyright-content">
    <b>鼠算式フレーズ練習帳</b> &copy; 2021 しかく<a href="https://twitter.com/shikaku1068">@shikaku1068</a>
  </div>
</div>
