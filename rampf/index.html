<!DOCTYPE html>
<meta charset="utf-8">
<title>鼠算式フレーズ練習帳</title>
<script type="module">
  import {QueryParser} from './js/query-parser.js';
  import {RabbitPhrase} from './js/rabbit-phrase.js';
  const dataset = {};
  const main = () => {
    const queryParser = new QueryParser();
    dataset.lead = queryParser.getValue('lead', 'string', '');
    dataset.questionTemplate = queryParser.getValue('question', 'string', '');
    dataset.answerTemplate = queryParser.getValue('answer', 'string', '');
    dataset.changeCount = 0;

    // dummy
    {
      dataset.lead = '"A love B."';
      dataset.questionTemplate = '^[私|あなた|彼|私^^[a|b|c]たち]はああああああああaaaaaaaaaaああああああああああああ^^[車|食べること|いたずら]が大好き^[11|22|33|44]かも。';
      dataset.answerTemplate = '^[I|Y^^[aa|bb|cc]ou|He|We] love^[||s|] ^^[cars|eating|playing tricks].';
    }
    if (dataset.lead) {
      const leadContainer = document.querySelector('#lead-frame');
      leadContainer.append(dataset.lead);
    }
    changeCard();
  };
  const changeCard = () => {
    const pathIdSeed = Math.random();
    const questionPhrase = new RabbitPhrase(dataset.questionTemplate, pathIdSeed);
    const answerPhrase = new RabbitPhrase(dataset.answerTemplate, pathIdSeed);
    const questionWrapper = document.querySelector('#question-wrapper');
    questionWrapper.innerHTML = questionPhrase.html;
    questionPhrase.chosenBranchTexts.forEach((currentValue, index, array) => {
      const branchNumber = index;
      const hintText = answerPhrase.chosenBranchTexts[branchNumber];
      const branchWrapper = document.querySelector(`.branch[data-branch-number="${index}"`);
      if (! branchWrapper) return;
      const zeroWidthSpace = document.createTextNode('\u200b');
      branchWrapper.append(zeroWidthSpace);
      const hintWrapper = document.createElement('div');
      hintWrapper.className = 'hint-wrapper';
      hintWrapper.innerText = hintText;
      branchWrapper.append(hintWrapper);
      const questionWrapperWidth = questionWrapper.clientWidth;
      const hintWrapperRight = branchWrapper.offsetLeft + hintWrapper.offsetWidth;
      const hintWrapperOffsetX = Math.min(questionWrapperWidth - hintWrapperRight, 0);
      const branchWrapperLeft = branchWrapper.offsetLeft;
      const hintWrapperLeft = branchWrapperLeft + hintWrapperOffsetX;
      hintWrapper.style.left = `${hintWrapperLeft}px`;
      const branchWrapperTop = branchWrapper.offsetTop;
      const hintWrapperHeight = hintWrapper.offsetHeight;
      const hintWrapperTop = branchWrapperTop - hintWrapperHeight;
      hintWrapper.style.top = `${hintWrapperTop}px`;

      const hintHornA = document.createElement('div');
      hintHornA.className = 'hint-horn-a';
      hintWrapper.append(hintHornA);
      hintHornA.style.marginLeft = `${- hintWrapperOffsetX}px`;
/*
      const hintBalloonHornA = document.createElement('div');

      hintBalloonHornA.style.cssText = `
        position: absolute;
        bottom: -.75em;
        left: .25em;
        border: .25em solid transparent;
        border-top: .5em solid gray;
        margin-left: ${- hintWrapperOffsetX}px;
      `;
      hintWrapper.append(hintBalloonHornA);
      const hintBalloonHornB = document.createElement('div');
      hintBalloonHornB.style.cssText = `
        position: absolute;
        bottom: -.55em;
        left: .25em;
        border: .25em solid transparent;
        border-top: .5em solid white;
        margin-left: ${- hintWrapperOffsetX}px;
      `;
      hintWrapper.append(hintBalloonHornB);
      hintWrapper.style.display = 'none';
      branchWrapper.addEventListener('mouseenter', e => {
        hintWrapper.style.display = 'block';
      });
      branchWrapper.addEventListener('mouseleave', e => {
        hintWrapper.style.display = 'none';
      });
//      document.body.addEventListener('touchstart', e => {
      hintWrapper.addEventListener('touchstart', e => {
        e.preventDefault();
        e.stopPropagation();
        hintWrapper.style.display = 'block';
      }, {passive: false});
      document.body.addEventListener('touchmove', e => {
//        if (! isHintShown) return;
        e.preventDefault();
        e.stopPropagation();
      }, {passive: false});
      hintWrapper.addEventListener('touchend', e => {
        hintWrapper.style.display = 'none';
      }, {passive: false});
      hintWrapper.addEventListener('touchcancel', e => {
        hintWrapper.style.display = 'none';
      }, {passive: false});
*/


      /*
      .hint:before {
    content: "";
    position: absolute;
    bottom: -.75em;
    left: .2em;
    border: .25em solid transparent;
    border-top: .5em solid gray;
//    z-index: 2;
  }
*/

      //alert(`${branchWrapper.offsetLeft}, ${questionWrapper.clientWidth}, ${hintWrapper.offsetWidth}`);
 /*
   .hint-wrapper {
//    display: none;
    white-space: nowrap;
    position: absolute;
margin-top: -.4em;
    padding: .4em;
    border: .1em solid gray;
    border-radius: .4em;
    background-color: white;
  }
*/
 
 
    });
    return;


/*
    const nodeElements = questionContainer.querySelectorAll('.node');
    for (const nodeElement of nodeElements) {
      const hoge = document.createElement('div');
      hoge.className = 'hint';
      const nodeLevel = nodeElement.dataset.nodeLevel;
      const validNode = answerPhrase.validNodes[nodeLevel];
      hoge.dataset.nodeLevel = nodeLevel;
      hoge.innerHTML = validNode;
//      nodeElement.parentElement.append(hoge);
const textNode = document.createElement('span');
textNode.innerHTML = '&#8203;';
nodeElement.after(textNode);
nodeElement.after(hoge);
      hoge.style.left = Math.min(nodeElement.offsetLeft, div.clientWidth - hoge.offsetWidth) + 'px';
//alert(`${nodeElement.offsetLeft}, ${div.clientWidth - hoge.offsetWidth}`);
//alert(div.width);
hoge.style.top = `${nodeElement.offsetTop - hoge.offsetHeight}px`;
hoge.style.display = 'none';

*/
      /*
      hoge.style.display = 'none';
      nodeElement.addEventListener('mouseover', e => {
        hoge.style.display = 'block';
      });
      nodeElement.addEventListener('mouseout', e => {
        hoge.style.display = 'none';
      });
*/
    }



    const answerElement = document.querySelector('#answer');
    answerElement.innerHTML = answerPhrase.html;
    const statisticText = `（総パターン数：${questionPhrase.possiblePatternCount}，パターンID：${questionPhrase.patternId}，通算回答数：${dataset.changeCount++}）`;
    const statisticElement = document.querySelector('#statistic');
    statisticElement.innerText = statisticText;
  };

  window.addEventListener('DOMContentLoaded', main);
</script>
<style>

  * {
//    overflow: hidden;
    box-sizing: border-box;
  }
  html {
    height: 100%;
    width: 100%;
    font-size: min(1rem, 5vmin);
    font-family: sans-serif;
  }
  body {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    margin: 0;
  }
  #app-container {
    display: flex;
    height: 100%;
    width: 100%;
    flex: 1 1 auto;
    flex-direction: column;
  }
  #lead-frame {
    display: flex;
    padding: 1.5rem;
    justify-content: center;
    font-size: 1.5rem;
  }
  #question-frame {
    display: flex;
    flex: 1 1 auto;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    padding: 3rem;
  }
  #question-wrapper {
    position: relative;
  }
  #answer-frame {
    display: flex;
    flex: 1 1 auto;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    padding: 3rem;
  }
  #statistic-frame {
display: flex;
    padding: 1.5rem;
        justify-content: flex-start;
  }
  #copyright-frame {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: .5rem 1rem;
  }
  .hint-wrapper {
    position: absolute;
    white-space: nowrap;
    padding: .4em;
    border: .1em solid gray;
    border-radius: .4em;
    background-color: white;
    margin-top: -.5em;
  }
  .hint-horn-a {
    position: absolute;
    left: 0;
    top: 100%;
  }
  .hint-horn-a:before {
    position: absolute;
    bottom: -.75em;
    left: .25em;
    border: .25em solid transparent;
    border-top: .5em solid gray;
    content: "";
  }
  .hint-horn-a:after {
    position: absolute;
    bottom: -.55em;
    left: .25em;
    border: .25em solid transparent;
    border-top: .5em solid white;
    content: "";
  }

/*
        position: absolute;
        bottom: -.75em;
        left: .25em;
        border: .25em solid transparent;
        border-top: .5em solid gray;
        margin-left: ${- hintWrapperOffsetX}px;
      `;
      hintWrapper.append(hintBalloonHornA);
      const hintBalloonHornB = document.createElement('div');
      hintBalloonHornB.style.cssText = `
        position: absolute;
        bottom: -.55em;
        left: .25em;
        border: .25em solid transparent;
        border-top: .5em solid white;
        margin-left: ${- hintWrapperOffsetX}px;




*/


/*
  .hint {
    position: absolute;
//    margin-top: -2em;
//    margin-left: -.25em;
//width: 0;
//left: calc(100%);
//top: 100%;
//left: 0;
    padding: .5em;
    border: .1em solid gray;
    border-radius: .25em;
    background-color: white;
    overflow: visible;
  }

  .hint:before {
    content: "";
    position: absolute;
    bottom: -.75em;
    left: .2em;
    border: .25em solid transparent;
    border-top: .5em solid gray;
//    z-index: 2;
  }
  .hint:after {
    content: "";
    position: absolute;
    bottom: calc(-.75em + .2em);
    left: .2em;
    border: .25em solid transparent;
    border-top: .5em solid white;
//    z-index: 2;
  }
  .node:not(:hover) .hint {
    display: none;
  }
*/
/*
  .hint-wrapper {
//    display: none;
    white-space: nowrap;
    position: absolute;
margin-top: -.4em;
    padding: .4em;
    border: .1em solid gray;
    border-radius: .4em;
    background-color: white;
  }
  .hint-wrapper:before {
    content: "";
    position: absolute;
    bottom: -.75em;
    left: .2em;
    border: .25em solid transparent;
    border-top: .5em solid gray;
  }
  .hint-wrapper:after {
    content: "";
    position: absolute;
    bottom: calc(-.75em + .2em);
    left: .2em;
    border: .25em solid transparent;
    border-top: .5em solid white;
  }
  .node:hover + .hint {
    display: block !important;
  }
*/
/*
  .branch:hover .hint {
    display: block !important;
  }
*/
  .branch {
    padding-right: .1em;
    padding-left: .1em;
    font-weight: bold;
  }
  .branch[data-branch-number="1"],
  .branch[data-branch-number="6"] {
    background-color: #F82F6666;
  }
  .branch[data-branch-number="2"],
  .branch[data-branch-number="7"] {
    background-color: #008ECF66;
  }
  .branch[data-branch-number="3"],
  .branch[data-branch-number="8"] {
    background-color: #70BE4766;
  }
  .branch[data-branch-number="4"],
  .branch[data-branch-number="9"] {
    background-color: #F55A2166;
  }
  .branch[data-branch-number="5"],
  .branch[data-branch-number="0"] {
    background-color: #F0EA3066;
  }

</style>
<div id="app-container">
  <div id="lead-frame"></div>
  <div id="question-frame">
    <div id="question-wrapper"></div>
  </div>
  <div id="answer-frame"></div></div>
  <div id="statistic-frame"></div>
  <div id="copyright-frame"><small><b>鼠算式フレーズ練習帳</b> &copy; 2021 しかく<a href="https://twitter.com/shikaku1068">@shikaku1068</a></small></div>
</div>