<!DOCTYPE html>
<meta charset="utf-8">
<title>鼠算式フレーズ練習帳</title>
<script type="module">
  import {QueryParser} from './js/query-parser.js';
  import {RabbitPhrase} from './js/rabbit-phrase.js';
  const dataset = {};
  const main = () => {
    const queryParser = new QueryParser();
    dataset.lead = queryParser.getValue('lead', 'string', '');
    dataset.questionTemplate = queryParser.getValue('question', 'string', '');
    dataset.answerTemplate = queryParser.getValue('answer', 'string', '');
    dataset.changeCount = 0;

    // dummy
    {
      dataset.lead = 'あああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓあああdsふぁｓｄふぁｓ';
      dataset.questionTemplate = '^[私|あなた|彼|私たち]aaああskdfじゃkskdfじゃkskdfじゃkskdfじゃkskdfじゃkskdfじゃkskdfじゃksjdフィアsjフィオアウェウリおjqウィオエjフィdウィ絵おfジョイdジェ入りクェ雨fじゃsどいdファおddフィジャウィ絵おdリオ亜dジェイおrじゃいおうぇうりおうぇういおrじおせああは^^[車ああああああああああああああああああああああああああ|食べるdsfadfasfasdsdfasdfasdfasdfsdafasdfasdfasdfasdfasの|いたずらするの]が大好き。';
      dataset.answerTemplate = '^[I|You|He|We] lovaaaae^[||s|] ^^[cars|eating|playing triaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaacks].';
    }



    initializeScreen();
  };
  const initializeScreen = () => {
    if (dataset.lead) {
      const leadContentElement = document.querySelector('#lead-content');
      leadContentElement.append(dataset.lead);
    }
    const copyrightContentElement = document.querySelector('#copyright-content');
    copyrightContentElement.innerHTML = '<b>鼠算式フレーズ練習帳</b> &copy; 2021 しかく<a href="https://twitter.com/shikaku1068">@shikaku1068</a>';


/*
    document.body.addEventListener('touchmove', event => {
      if (event.target.className == 'branch') {
        event.preventDefault();
        return;
      }
    }, {passive: false});
    document.body.addEventListener('click', event => {
      if (event.target.className == 'branch') {
        event.preventDefault();
        return;
      }
      alert('click');
    }, {passive: false});
*/
    resetCard();
  };
  const resetCard = () => {
    const pathIdSeed = Math.random();
    const questionPhrase = new RabbitPhrase(dataset.questionTemplate, pathIdSeed);
    const answerPhrase = new RabbitPhrase(dataset.answerTemplate, pathIdSeed);
    const queationContentElement = document.querySelector('#question-content');
    queationContentElement.innerHTML = questionPhrase.html;
    addHintBalloons(queationContentElement, answerPhrase.chosenBranchTexts, queationContentElement.clientWidth);
    const answerContentElement = document.querySelector('#answer-content');
    answerContentElement.innerHTML = answerPhrase.html;
    addHintBalloons(answerContentElement, questionPhrase.chosenBranchTexts, answerContentElement.clientWidth);
    const statisticHtml = `（総パターン数：${questionPhrase.possiblePathCount}，パターンID：${questionPhrase.pathId}，おかわり：${dataset.changeCount++}）`;
    const statisticContentElement = document.querySelector('#statistic-content');
    statisticContentElement.innerHTML = statisticHtml;
  };
  const addHintBalloons = (targetContent, hintTextList) => {
    const branchElements = targetContent.querySelectorAll('[data-branch-number]');
    for (const branchElement of branchElements) {
      const branchNumber = Number(branchElement.dataset.branchNumber);
      const hintBalloonContentElement = document.createElement('span');
      hintBalloonContentElement.className = 'hint-balloon-content';
      const hintText = hintTextList[branchNumber];
      hintBalloonContentElement.innerText = hintText;
      const hintBalloonWrapperElement = document.createElement('span');
      hintBalloonWrapperElement.className = 'hint-balloon-wrapper';
      hintBalloonWrapperElement.append(hintBalloonContentElement);
      branchElement.append(hintBalloonWrapperElement);


      const appContainerElement = document.querySelector('#app-container');
      const hintBalloonRight = branchElement.getClientRects()[0].left + hintBalloonWrapperElement.offsetWidth;
      const hintBalloonContentMarginLeft = Math.min(0, appContainerElement.offsetWidth - hintBalloonRight);
      hintBalloonContentElement.style.marginLeft = `${hintBalloonContentMarginLeft}px`;
      branchElement.addEventListener('mouseenter', e => {
        const branchElement = e.target;
        const hintBalloonWrapperElement = branchElement.querySelector('.hint-balloon-wrapper');
        const branchRect = branchElement.getBoundingClientRect();
        hintBalloonWrapperElement.style.top = `${branchRect.top}px`;
        hintBalloonWrapperElement.style.left = `${branchElement.offsetLeft}px`;
        hintBalloonWrapperElement.style.animation = 'fadeIn 500ms';
      });
      branchElement.addEventListener('mouseleave', e => {
        const branchElement = e.target;
        const hintBalloonWrapperElement = branchElement.querySelector('.hint-balloon-wrapper');
        hintBalloonWrapperElement.style.animation = 'fadeOut 500ms';
      });
    }
  }
/*
  const addHintBalloons = (targetContent, hintTextList) => {
    targetContent.style.width = '100%';
    const hintBalloonMarginRight = targetContent.offsetLeft;
    targetContent.style.width = '';
    const hintBalloonMaxWidth = targetContent.offsetWidth + targetContent.offsetLeft - hintBalloonMarginRight;
    const branchElements = targetContent.querySelectorAll('[data-branch-number]');
    for (const branchElement of branchElements) {
      const branchNumber = Number(branchElement.dataset.branchNumber);
      const hintBalloonContentElement = document.createElement('div');
      hintBalloonContentElement.className = 'hint-balloon-content';
      const hintText = hintTextList[branchNumber];
      hintBalloonContentElement.innerText = hintText;
      branchElement.after(hintBalloonContentElement);
      const hintBalloonWrapperElement = document.createElement('div');
      hintBalloonWrapperElement.className = 'hint-balloon-wrapper';
      hintBalloonContentElement.after(hintBalloonWrapperElement);
      const hintBalloonTop = branchElement.offsetTop - hintBalloonContentElement.offsetHeight;
      const hintBalloonLeft = branchElement.offsetLeft;
      const hintBalloonWidth = hintBalloonContentElement.offsetWidth;
      const hintBalloonHeight = hintBalloonContentElement.offsetHeight;
      const hintBalloonContentMaxLeft = hintBalloonMaxWidth - hintBalloonWidth;
      const hintBalloonContentMarginLeft = Math.min(0, hintBalloonContentMaxLeft - hintBalloonLeft);
      hintBalloonContentElement.style.left = `${hintBalloonLeft}px`;
      hintBalloonContentElement.style.top = `${hintBalloonTop}px`;
      hintBalloonContentElement.style.marginLeft = `${hintBalloonContentMarginLeft}px`;
      hintBalloonWrapperElement.style.left = `${hintBalloonLeft}px`;
      hintBalloonWrapperElement.style.top = `${hintBalloonTop}px`;
      hintBalloonWrapperElement.style.width = `${hintBalloonWidth}px`;
      hintBalloonWrapperElement.style.height = `${hintBalloonHeight}px`;
    }
  };
*/
window.addEventListener('DOMContentLoaded', main);
</script>
<style>
  * {
    box-sizing: border-box;
    overflow: hidden;
  }
  html {
    font-size: 4vmin;
    font-family: sans-serif;
  }
  #app-container {
    display: grid;
    grid-template:
      "lead lead" min-content
      "question answer" 1fr
      "controller controller" min-content
      "statistic copyright" min-content
      / 50% 50%;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #99ddff;
  }
  @media screen and (orientation: portrait) {
    #app-container {
      grid-template:
        "lead" min-content
        "question" 1fr
        "answer" 1fr
        "controller" min-content
        "statistic" min-content
        "copyright" min-content
        / 100%;
    }
  }
  #lead-wrapper {
    grid-area: lead;
    max-height: 20vh;
    overflow-y: auto;
    font-size: 1.2rem;
  }
  #lead-content {
    padding: .4rem 1rem;
  }
  #question-wrapper {
    grid-area: question;
    margin: 0 .4rem .4rem 0;
  }
  #answer-wrapper {
    grid-area: answer;
    margin: .4rem 0 0 .4rem;
  }
  #question-wrapper,
  #answer-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: .4rem 1rem;
    overflow-y: auto;
    font-size: 1.6rem;
    background: #ffffffcc;
  }
  #lead-content,
  #question-content,
  #answer-content {
    margin: auto;
    overflow-wrap: anywhere;
  }
  #controller-wrapper {
    grid-area: controller;
    padding: .4rem 1rem;
    font-size: 1rem;
    text-align: right;
  }
  #play-audio-button,
  #auto-play-audio-checkbox,
  #continue-button {
    font-size: 1.6rem;
  }
  #statistic-wrapper {
    grid-area: statistic;
    padding: .4rem 1rem;
    font-size: .8rem;
  }
  #copyright-wrapper {
    grid-area: copyright;
    padding: .4rem 1rem;
    font-size: .8rem;
    text-align: right;
  }
  .branch {
    padding-left: .2em;
    padding-right: .2em;
    font-weight: bold;
  }
  .branch[data-branch-number="1"],
  .branch[data-branch-number="6"] {
    background-color: #F82F6666;
  }
  .branch[data-branch-number="2"],
  .branch[data-branch-number="7"] {
    background-color: #008ECF66;
  }
  .branch[data-branch-number="3"],
  .branch[data-branch-number="8"] {
    background-color: #70BE4766;
  }
  .branch[data-branch-number="4"],
  .branch[data-branch-number="9"] {
    background-color: #F55A2166;
  }
  .branch[data-branch-number="5"],
  .branch[data-branch-number="0"] {
    background-color: #F0EA3066;
  }
  .hint-balloon-wrapper {
    --hint-balloon-font-size: 1em;
    --hint-balloon-height: calc(var(--hint-balloon-font-size) * 1.6);
    --hint-balloon-background-color: #fff;
    --hint-balloon-border-color: #999;
    --hint-balloon-border-width: .2rem;
    display: block;
    visibility: hidden;
    position: fixed;
    height: var(--hint-balloon-height);
    margin-top: calc(var(--hint-balloon-height) * -1 - var(--hint-balloon-border-width));
    overflow: visible;
    font-weight: bold;
    font-size: var(--hint-balloon-font-size);
  }
  .hint-balloon-wrapper:before {
    display: block;
    position: absolute;
    top: 100%;
    left: calc(var(--hint-balloon-border-width) * 2);
    border: calc(var(--hint-balloon-border-width) * 2) solid transparent;
    border-top: calc(var(--hint-balloon-border-width) * 4) solid var(--hint-balloon-border-color);
    content: "";
  }
  .hint-balloon-wrapper:after {
    display: block;
    position: absolute;
    top: calc(100% - .2rem * 2);
    left: calc(var(--hint-balloon-border-width) * 2);
    border: calc(var(--hint-balloon-border-width) * 2) solid transparent;
    border-top: calc(var(--hint-balloon-border-width) * 4) solid var(--hint-balloon-background-color);
    content: "";
  }
  .hint-balloon-content {
    display: flex;
    align-items: center;
    height: 100%;
    padding: 0 calc(var(--hint-balloon-border-width) * 2);
    border: var(--hint-balloon-border-width) solid var(--hint-balloon-border-color);
    background-color: var(--hint-balloon-background-color);
    white-space: nowrap;
  }
  .branch:hover .hint-balloon-wrapper {
    visibility: visible;
  }
  @keyframes fadeIn {
    0% {
      visibility: hidden;
      opacity: 0;
    }
    100% {
      visibility: visible;
      opacity: 1;
    }
  }
  @keyframes fadeOut {
    0% {
      visibility: visible;
      opacity: 1;
    }
    100% {
      visibility: hidden;
      opacity: 0;
    }
  }
</style>
<div id="app-container">
  <div id="lead-wrapper">
    <div id="lead-content"></div>
  </div>
  <div id="question-wrapper">
    <div id="question-content"></div>
  </div>
  <div id="answer-wrapper">
    <div id="answer-content"></div>
  </div>
  <div id="controller-wrapper">
    <div id="controller-content">
      <button id="play-audio-button">音声再生</button><input type="checkbox" id="auto-play-audio-checkbox">
      <button id="continue-button">次の問題</button>
    </div>
  </div>
  <div id="statistic-wrapper">
    <div id="statistic-content"></div>
  </div>
  <div id="copyright-wrapper">
    <div id="copyright-content"></div>
  </div>
</div>
