<!DOCTYPE html>
<meta charset="utf-8">
<title>鼠算式フレーズ練習帳</title>
<script type="module">
  import {QueryParser} from './js/query-parser.js';
  import {RabbitPhrase} from './js/rabbit-phrase.js';
  const dataset = {};
  const main = () => {
    const queryParser = new QueryParser();
    dataset.lead = queryParser.getValue('lead', 'string', '');
    dataset.questionTemplate = queryParser.getValue('question', 'string', '');
    dataset.answerTemplate = queryParser.getValue('answer', 'string', '');
    dataset.changeCount = 0;

    // dummy
    {
      dataset.lead = '"A love B.safdaaaaaaaaaaaaaaaaあああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああ"';
      dataset.questionTemplate = '^[私|あなた|彼|私たち]aaaaあああああああああああああああううううううううううううううううううううううううううううううううううううううううううううううううううあああああああああああああああああああああああああああああああああああは^^[車ああああああああああああああああああああああああああ|食べるの|いたずらするの]が大好き。';
      dataset.answerTemplate = '^[I|You|He|We] lovaaaae^[||s|] ^^[cars|eating|playing tricks].';
    }



    initializeScreen();
  };
  const initializeScreen = () => {
    if (dataset.lead) {
      const leadElement = document.querySelector('#lead');
      leadElement.append(dataset.lead);
    }
    const copyrightElement = document.querySelector('#copyright');
    copyrightElement.innerHTML = '<b>鼠算式フレーズ練習帳</b> &copy; 2021 しかく<a href="https://twitter.com/shikaku1068">@shikaku1068</a>';
    document.body.addEventListener('touchmove', event => {
      if (event.target.className == 'branch') {
        event.preventDefault();
        return;
      }
    }, {passive: false});
    document.body.addEventListener('click', event => {
      if (event.target.className == 'branch') {
        event.preventDefault();
        return;
      }
      alert('click');
    }, {passive: false});
    window.addEventListener('resize', onResize);
    adjustScreen();
    resetCard();
  };
  const adjustScreen = () => {
    const appContainerElement = document.querySelector('#container');
    if (appContainerElement.offsetWidth > appContainerElement.offsetHeight) {
      appContainerElement.classList.add('is-landscape');
    } else {
      appContainerElement.classList.remove('is-landscape');
    }
  };
  const resetCard = () => {
    const pathIdSeed = Math.random();
    const questionPhrase = new RabbitPhrase(dataset.questionTemplate, pathIdSeed);
    const answerPhrase = new RabbitPhrase(dataset.answerTemplate, pathIdSeed);
    const questionElement = document.querySelector('#question');
    questionElement.innerHTML = questionPhrase.html;
    addHintBalloons(questionElement, answerPhrase.chosenBranchTexts, questionElement.clientWidth);
    const answerElement = document.querySelector('#answer');
    answerElement.innerHTML = answerPhrase.html;
    addHintBalloons(answerElement, questionPhrase.chosenBranchTexts, answerElement.clientWidth);
    const statisticHtml = `（総パターン数：${questionPhrase.possiblePathCount}，パターンID：${questionPhrase.pathId}，問題番号：${dataset.changeCount++}）`;
    const statisticElement = document.querySelector('#statistic');
    statisticElement.innerHTML = statisticHtml;
  };
  const addHintBalloons = (targetContent, hintTextList) => {
    targetContent.style.width = '100%';
    const hintBalloonMarginRight = targetContent.offsetLeft;
    targetContent.style.width = '';
    const hintBalloonMaxWidth = targetContent.offsetWidth + targetContent.offsetLeft - hintBalloonMarginRight;
    const branchElements = targetContent.querySelectorAll('[data-branch-number]');
    for (const branchElement of branchElements) {
      const branchNumber = Number(branchElement.dataset.branchNumber);
      const hintBalloonBodyElement = document.createElement('div');
      hintBalloonBodyElement.className = 'hint-balloon-body';
      const hintText = hintTextList[branchNumber];
      hintBalloonBodyElement.innerText = hintText;
      branchElement.after(hintBalloonBodyElement);
      const hintBalloonTailElement = document.createElement('div');
      hintBalloonTailElement.className = 'hint-balloon-tail';
      hintBalloonBodyElement.after(hintBalloonTailElement);
      const hintBalloonTop = branchElement.offsetTop - hintBalloonBodyElement.offsetHeight;
      const hintBalloonLeft = branchElement.offsetLeft;
      const hintBalloonWidth = hintBalloonBodyElement.offsetWidth;
      const hintBalloonHeight = hintBalloonBodyElement.offsetHeight;
      const hintBalloonBodyMaxLeft = hintBalloonMaxWidth - hintBalloonWidth;
      const hintBalloonBodyMarginLeft = Math.min(0, hintBalloonBodyMaxLeft - hintBalloonLeft);
      hintBalloonBodyElement.style.left = `${hintBalloonLeft}px`;
      hintBalloonBodyElement.style.top = `${hintBalloonTop}px`;
      hintBalloonBodyElement.style.marginLeft = `${hintBalloonBodyMarginLeft}px`;
      hintBalloonTailElement.style.left = `${hintBalloonLeft}px`;
      hintBalloonTailElement.style.top = `${hintBalloonTop}px`;
      hintBalloonTailElement.style.width = `${hintBalloonWidth}px`;
      hintBalloonTailElement.style.height = `${hintBalloonHeight}px`;
    }
  };
  const onResize = event => {
    window.clearTimeout(onResize.timeoutId);
    onResize.timeoutId = window.setTimeout(adjustScreen, 1000);
  };
  window.addEventListener('DOMContentLoaded', main);
</script>
<style>
  * {
    box-sizing: border-box;
  }
  :root {
    font-size: 4vmin;
    font-family: sans-serif;
  }
  #container {
    display: grid;
grid-template-rows: max-content 1fr 1fr max-content max-content;
grid-template-columns: 50% 50%;
      grid-template-areas:
        "lead lead"
        "question answer"
        "question answer"
        "statistic statistic"
        "copyright copyright";
width: 100%;
height: 100%;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
  @media screen and (orientation: portrait) {
    #container {
      grid-template-areas:
        "lead lead"
        "question question"
        "answer answer"
        "statistic statistic"
        "copyright copyright";
    }
  }
  #lead {
    padding: .5rem 1rem;
    font-size: 1.2rem;
grid-area: lead;
  }
  #question {
    grid-area: question;
  }
  #answer {
    grid-area: answer;
  }
  #question,
  #answer {
//    max-height: 100%;
    overflow-y: auto;
  }

  #question,
  #answer {
    padding: .5rem 1rem;
    font-size: 5rem;
    background: gold;
  }

  #statistic {
    grid-area: statistic;
    padding: .5em .5em;
    font-size: .8rem;
background: blue;
  }
  #copyright {
  grid-area: copyright;
    padding: .5em .5em;
    font-size: .8rem;
    text-align: right;
    min-height: 3em;
  }
  .branch {
    padding-left: .2em;
    padding-right: .2em;
    font-weight: bold;
  }
  .branch[data-branch-number="1"],
  .branch[data-branch-number="6"] {
    background-color: #F82F6666;
  }
  .branch[data-branch-number="2"],
  .branch[data-branch-number="7"] {
    background-color: #008ECF66;
  }
  .branch[data-branch-number="3"],
  .branch[data-branch-number="8"] {
    background-color: #70BE4766;
  }
  .branch[data-branch-number="4"],
  .branch[data-branch-number="9"] {
    background-color: #F55A2166;
  }
  .branch[data-branch-number="5"],
  .branch[data-branch-number="0"] {
    background-color: #F0EA3066;
  }
  .hint-balloon-body {
    visibility: hidden;
    position: absolute;
  }
  .hint-balloon-tail {
    visibility: hidden;
    position: absolute;
  }
</style>
<div id="container">
  <div id="lead"></div>
  <div id="question"></div>
  <div id="answer"></div>
  <div id="statistic"></div>
  <div id="copyright"></div>
</div>
