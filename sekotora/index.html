<!DOCTYPE html>
<meta charset="UTF-8">
<title>test</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/plain" id="cards">
{aaa=bbb|ccc} {=aaa}
{のんちゃん|ゆいみさん|ともくん}の趣味は{ダンス|お父さんいじり|ラミー収集}です。	{Non-chan|Yui-san|Tomo-kun}'s hobby is {dancing|teasing her husband|collecting Lamys}.  
{日本|アメリカ|カナダ|ドイツ|オーストリア|フランス|イタリア|スペイン|ロシア|オーストラリア|中国|韓国}の首都は{東京|ワシントン|オタワ|ベルリン|ウィーン|パリ|ローマ|マドリード|モスクワ|キャンベラ|北京|ソウル}です。	The capital city of {Japan|the USA|Canada|Germany|Austria|France|Italy|Spain|Russia|Australia|China|Korea} is {Tokyo|Washington|Ottawa|Berlin|Vienna|Paris|Rome|Madrid|Moscow|Canberra|Beijing|Seoul}.
{*I|He|They} love{*|s|} {**Jane|her}.	{*私|彼|彼ら}は{**ジェーン|彼女}を愛しています。
I like {*animals|dogs|cats|pandas|elephants}.	私は{*動物|犬|猫|パンダ|象}が好きです。
</script>
<style>
*, *:before, *:after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
html, body {
  width: 100%;
  height: 100%;
}
#main {
  display: table;
  width: 100%;
  height: 100%;
}
#question, #answer {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
}
b.alt0 {
  background: rgba(237,137,49,0.4);
}
b.alt1 {
  background: rgba(251,235,100,0.4);
}
b.alt2 {
  background: rgba(170,206,84,0.4);
}
b.alt3 {
  background: rgba(20,147,200,0.4);
}
b.alt4 {
  background: rgba(221,19,121,0.4);
}
</style>
<div id="main">
  <div id="question"></div>
  <div id="answer"></div>
</div>
<script>
const getQuery = (queryName) => {
  let query = '';
  if (location.search) {
    const match = location.search.match(new RegExp('(\\?|&)' + queryName + '=[^&]*', 'i'));
    if (match) query = match[0].substring(queryName.length + 3);
  }
  return query;
}
</script>
<script>
const getCards = (cardsTextUrl) => {

}
const speech = function(text, ignoresTags, lang, voiceName)
{
  clearTimeout(speech.timeoutId);
  speechSynthesis.cancel();
  (function loop()
  {
    let voices = speechSynthesis.getVoices();
    if(voices == 0)
    {
      speech.timeoutId = setTimeout(loop, 200);
      return;
    }
    let ssu = new SpeechSynthesisUtterance();
    ssu.text = (ignoresTags? text.replace(/<.*?>/g, ''): text);
    if(lang) ssu.lang = lang;
    for(let i = 0; i < voices.length; i++)
    {
      if(voices[i].voiceName == voiceName)
      {
        ssu.voice = voices[i];
        break;
      }
    }
    speechSynthesis.speak(ssu);
  })();
};
const getQuiz = function(card)
{
  let randomNumbers = [];
  while(true)
  {
    let hoge = 0;
    card = card.replace(/\{(\**)([^{]*?)\}/g,
      function(match, p1, p2, offset, string)
      {
        hoge++;
        let altId = p1.length;
        if(randomNumbers[altId] == undefined)
        {
          randomNumbers[altId] = Math.random();
        }
        let items = p2.split('|');
        for(let i = 1; i < items.length; i++)
        {
          items[i] = items[i].replace(/~/g, items[i - 1].trim());
        }
        return '<b class="alt' + altId + '">' + items[Math.floor(randomNumbers[altId] * items.length)] + '</b>';
      }
    );
    if(hoge == 0) break;
  }
  let question = card.replace(/\t.*$/, '');
  let answer = card.replace(/^.*?\t/, '');
  return {question: question, answer: answer};
};
const showQuiz = function(cards, cardIndex)
{
  quiz = getQuiz(cards[cardIndex]);
  $('#question')
    .html(quiz.question)
    .show()
    .on('click', function()
    {
      $('#question').hide();
      $('#answer').show();
      speech(quiz.answer, true, 'en-US', 'Google US English');
    });
  $('#answer')
    .html(quiz.answer)
    .hide()
    .on('click', function()
    {
      $('#question').show();
      $('#answer').hide();
      speech(quiz.question, true, 'ja-JP', 'Google 日本語');
    });
  speech(quiz.question, true, 'ja-JP', 'Google 日本語');
};
</script>
<script>
{
  let startingOffsetX, startingOffsetY;
  const tap = () => {
    alert('・/');
  };
  const left = () => {
  }
  const right = () => {
  }
  const up = () => {
  }
  const down = () => {
  }
  const startSwipe = (x, y) => {
    startingOffsetX = x;
    startingOffsetY = y;
  };
  const endSwipe = (x, y) => {
    if (startingOffsetX == null || startingOffsetY == null) {
      return;
    }
    let movingX = x - startingOffsetX;
    let movingY = y - startingOffsetY;
    if(movingX == 0 && movingY == 0) {
      tap();
    }
    else if (Math.abs(movingX) > Math.abs(movingY) * 2) {
      if (movingX < 0) {
        left();
      }
      else {
        right();
      }
    }
    else if (Math.abs(movingY) > Math.abs(movingX) * 2) {
      if(movingY < 0) {
        up();
      }
      else {
        down();
      }
    }
    startingOffsetX = null;
    startingOffsetY = null;
  };
  const bodyElement = document.querySelector('body');
  if (bodyElement.onclick !== undefined) {
    bodyElement.addEventListener('click', (e) => {
      tap();
      e.preventDefault();
      e.stopPropagation();
    }, true);
    bodyElement.addEventListener('mousedown', (e) => {
      startSwipe(e.offsetX, e.offsetY);
      e.preventDefault();
      e.stopPropagation();
    }, true);
    bodyElement.addEventListener('mouseup', (e) => {
      endSwipe(e.offsetX, e.offsetY);
      e.preventDefault();
      e.stopPropagation();
    }, true);
  }
  if (bodyElement.ontouchstart !== undefined) {
    alert(11);
  }
}







const cardsTextUrl = getQuery('url');
if (cardsTextUrl) {
  const d_el = document.querySelector('#cards');
  document.body.removeChild(d_el);

  const element = document.createElement('script');
  element.type = 'text/plain';
  element.src = cardsTextUrl;
  element.id = 'cards';
  document.body.appendChild(element);
}


$(document).ready(function() {


  const replacementMap = new Map();
  let cardsText = document.querySelector('#cards').innerHTML;


  cardsText = cardsText.replace(/\{([^\n{}=]+)=([^\n{}]*)\}/g, (match, p1, p2, offset, string) => {
    replacementMap.set(p1, p2);
    return `{${p2}}`;
  });
  cardsText = cardsText.replace(/\{=([^\n{}]+)\}/g, (match, p1, offset, string) => {
    const replacement = replacementMap.get(p1);
    if (replacement) {
      return `{${replacement}}`;
    }
    else {
      return string;
    }
  });
  const hoge = new Map();
  const cards = cardsText.split('\n').filter(cardText => cardText.match(/\t/));

  /*
  alert(1);
  const cards = cardsText.split('\n').filter(cardText => cardText.match(/\t/));   //.map(cardText => {
    const items = cardText.split(\t);
    return new Map([
      ['question', items[0]],
      ['answer', items[1]],
      ['category', items[2]]
    ]);
  });
  alert(1);
  */

  //const cards = cardsText.split('\n');



  /*
  const tempCards = document.querySelector('#cards').innerHTML.split('\n');

  //tempCards = cardsText.split('\n');

  const cards = [];
  for (const card of tempCards) {
    cards.push(card);
  }
  */





  for(let i = cards.length - 1; i >= 0; i--)
  {
    if(cards[i].match(/^[^\t]+\t[^\t]+$/) == null) cards.splice(i, 1);
  }


  /*
  const cards = document.querySelector('#cards').innerHTML.split('\n');
  for(let i = cards.length - 1; i >= 0; i--)
  {
    if(cards[i].match(/^[^\t]+\t[^\t]+$/) == null) cards.splice(i, 1);
  }
  */
  let cardIndex = 0;
  let quiz;















  let startPos = {x: 0, y: 0};
  $('body').on('mousedown', function(e) {
    startPos = {x: e.offsetX, y: e.offsetY};
  });

  $('body').on('mouseup', function(e) {
    let moveX = e.offsetX - startPos.x;
    let moveY = e.offsetY - startPos.y
    if(Math.abs(moveX) > Math.abs(moveY))
    {
    }
    else
    {
    }
  });

  showQuiz(cards, cardIndex);
});
</script>
